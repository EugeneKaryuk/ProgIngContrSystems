# Aggregation Pipeline Stages 

https://www.mongodb.com/docs/manual/reference/operator/aggregation-pipeline/

У методі [`db.collection.aggregate()`](https://www.mongodb.com/docs/manual/reference/method/db.collection.aggregate/#mongodb-method-db.collection.aggregate) і метод [`db.aggregate()`](https://www.mongodb.com/docs/manual/reference/method/db.aggregate/#mongodb-method-db.aggregate), [конвеєр](https: //www.mongodb.com/docs/manual/core/aggregation-pipeline/) етапи відображаються в масиві. Документи проходять етапи послідовно.

## Stages 

### `db.collection.aggregate()` Stages 

Усі, крім [`$out`](https://www.mongodb.com/docs/manual/reference/operator/aggregation/out/#mongodb-pipeline-pipe.-out), [`$merge`]( https://www.mongodb.com/docs/manual/reference/operator/aggregation/merge/#mongodb-pipeline-pipe.-merge), [`$geoNear`](https://www.mongodb.com/ docs/manual/reference/operator/aggregation/geoNear/#mongodb-pipeline-pipe.-geoNear) і [`$changeStream`](https://www.mongodb.com/docs/manual/reference/operator/aggregation /changeStream/#mongodb-pipeline-pipe.-changeStream) етапи можуть з’являтися кілька разів у конвеєрі. Щоб отримати детальну інформацію про конкретний оператор, включаючи синтаксис і приклади, клацніть посилання на довідкову сторінку оператора.

```
db.collection.aggregate( [ { <stage> }, ... ] )
```

- [`$addFields`](https://www.mongodb.com/docs/manual/reference/operator/aggregation/addFields/#mongodb-pipeline-pipe.-addFields) - Додає нові поля до документів. Подібно до [`$project`](https://www.mongodb.com/docs/manual/reference/operator/aggregation/project/#mongodb-pipeline-pipe.-project), [`$addFields`](https ://www.mongodb.com/docs/manual/reference/operator/aggregation/addFields/#mongodb-pipeline-pipe.-addFields) змінює форму кожного документа в потоці; зокрема, шляхом додавання нових полів до вихідних документів, які містять як існуючі поля з вхідних документів, так і нещодавно додані поля.[`$set`](https://www.mongodb.com/docs/manual/reference/operator/ aggregation/set/#mongodb-pipeline-pipe.-set) є псевдонімом для [`$addFields`.](https://www.mongodb.com/docs/manual/reference/operator/aggregation/addFields/#mongodb -pipeline-pipe.-addFields)
- [`$bucket`](https://www.mongodb.com/docs/manual/reference/operator/aggregation/bucket/#mongodb-pipeline-pipe.-bucket) - Класифікує вхідні документи на групи, які називаються сегментами, на основі вказаного виразу та меж сегментів.
- [`$bucketAuto`](https://www.mongodb.com/docs/manual/reference/operator/aggregation/bucketAuto/#mongodb-pipeline-pipe.-bucketAuto) - Класифікує вхідні документи в певну кількість груп, які називаються сегментами, на основі вказаного виразу. Межі сегментів визначаються автоматично, намагаючись рівномірно розподілити документи по вказаній кількості сегментів.
- [`$changeStream`](https://www.mongodb.com/docs/manual/reference/operator/aggregation/changeStream/#mongodb-pipeline-pipe.-changeStream) -  Повертає курсор [Change Stream](https://www.mongodb.com/docs/manual/changeStreams/#std-label-changeStreams) для колекції. Цей етап може відбуватися лише один раз у конвеєрі агрегації, і він має відбуватися як перший етап.
- [`$collStats`](https://www.mongodb.com/docs/manual/reference/operator/aggregation/collStats/#mongodb-pipeline-pipe.-collStats) - Повертає статистику щодо колекції або перегляду.
- [`$count`](https://www.mongodb.com/docs/manual/reference/operator/aggregation/count/#mongodb-pipeline-pipe.-count) -  Повертає підрахунок кількості документів на цьому етапі конвеєра агрегації. Відмінно від [`$count`](https://www.mongodb.com/docs/manual/reference/operator/aggregation/count-accumulator/ #mongodb-group-grp.-count) накопичувач агрегації.
- [`$densify`](https://www.mongodb.com/docs/manual/reference/operator/aggregation/densify/#mongodb-pipeline-pipe.-densify) - Створює нові документи в послідовності документів, у яких відсутні певні значення в полі.
- [`$documents`](https://www.mongodb.com/docs/manual/reference/operator/aggregation/documents/#mongodb-pipeline-pipe.-documents) - Повертає літеральні документи з вхідних виразів.
- [`$facet`](https://www.mongodb.com/docs/manual/reference/operator/aggregation/facet/#mongodb-pipeline-pipe.-facet) - Обробляє кілька [конвеєрів агрегації](https://www.mongodb.com/docs/manual/core/aggregation-pipeline/#std-label-aggregation-pipeline) на одному етапі в одному наборі вхідних документів. Дозволяє створювати багатогранні агрегації, здатні характеризувати дані в кількох вимірах або аспектах за один етап.
- [`$fill`](https://www.mongodb.com/docs/manual/reference/operator/aggregation/fill/#mongodb-pipeline-pipe.-fill) - Заповнює нульові та відсутні значення полів у документах.
- [`$geoNear`](https://www.mongodb.com/docs/manual/reference/operator/aggregation/geoNear/#mongodb-pipeline-pipe.-geoNear) - Повертає впорядкований потік документів на основі близькості до геопросторової точки. Включає в себе функції [`$match`](https://www.mongodb.com/docs/manual/reference/operator/aggregation/match/#mongodb-pipeline-pipe.-match), [`$sort`](https://www.mongodb.com/docs/manual/reference/operator/aggregation/sort/#mongodb-pipeline-pipe.-sort) і [`$limit`](https://www.mongodb. com/docs/manual/reference/operator/aggregation/limit/#mongodb-pipeline-pipe.-limit) для геопросторових даних. Вихідні документи включають додаткове поле відстані та можуть містити поле ідентифікатора розташування.
- [`$graphLookup`](https://www.mongodb.com/docs/manual/reference/operator/aggregation/graphLookup/#mongodb-pipeline-pipe.-graphLookup) - Виконує рекурсивний пошук у колекції. До кожного вихідного документа додається нове поле масиву, яке містить результати обходу рекурсивного пошуку для цього документа.
- [`$group`](https://www.mongodb.com/docs/manual/reference/operator/aggregation/group/#mongodb-pipeline-pipe.-group) - Групує вхідні документи за вказаним виразом-ідентифікатором і застосовує вираз(и) накопичувача, якщо вони вказані, до кожної групи. Споживає всі вхідні документи та виводить по одному документу для кожної окремої групи. Вихідні документи містять лише поле ідентифікатора та, якщо вказано, накопичені поля.
- [`$indexStats`](https://www.mongodb.com/docs/manual/reference/operator/aggregation/indexStats/#mongodb-pipeline-pipe.-indexStats) - Повертає статистику щодо використання кожного індексу для колекції.
- [`$limit`](oper_limit.md) - Передає перші *n* документів незміненими в конвеєр, де *n* є вказаним обмеженням. Для кожного вхідного документа виводить або один документ (для перших *n* документів), або нуль документів (після перших *n* документів).
- [`$listSessions`](https://www.mongodb.com/docs/manual/reference/operator/aggregation/listSessions/#mongodb-pipeline-pipe.-listSessions) - Перераховує всі сеанси, які були активними достатньо довго, щоб перейти до колекції `system.sessions`.
- [`$lookup`](https://www.mongodb.com/docs/manual/reference/operator/aggregation/lookup/#mongodb-pipeline-pipe.-lookup) - Виконує ліве зовнішнє приєднання до іншої колекції в *той самій* базі даних, щоб відфільтрувати документи з «об’єднаної» колекції для обробки.
- [`$match`](oper_match.md) - Фільтрує потік документів, щоб дозволити лише відповідним документам передавати незмінені на наступний етап конвеєра. [`$match`](https://www.mongodb.com/docs/manual/reference/operator/aggregation/match/#mongodb-pipeline-pipe.-match) використовує стандартні запити MongoDB. Для кожного вхідного документа виводить один документ (збіг) або нуль документів (відсутність збігу).
- [`$merge`](https://www.mongodb.com/docs/manual/reference/operator/aggregation/merge/#mongodb-pipeline-pipe.-merge) - Записує отримані документи конвеєра агрегації до колекції. Етап може включати (вставляти нові документи, об’єднувати документи, замінювати документи, зберігати наявні документи, не виконувати операцію, обробляти документи за допомогою спеціального конвеєра оновлення) результати в вихідну колекцію. Щоб використовувати етап [`$merge`](https://www.mongodb.com/docs/manual/reference/operator/aggregation/merge/#mongodb-pipeline-pipe.-merge), він має бути останнім етапом у розробці.*Нове у версії 4.2*.
- [`$out`](https://www.mongodb.com/docs/manual/reference/operator/aggregation/out/#mongodb-pipeline-pipe.-out) -  Записує отримані документи конвеєра агрегації до колекції. Щоб використовувати етап [`$out`](https://www.mongodb.com/docs/manual/reference/operator/aggregation/out/#mongodb-pipeline-pipe.-out), він має бути останнім етапом в трубопроводі.
- [`$planCacheStats`](https://www.mongodb.com/docs/manual/reference/operator/aggregation/planCacheStats/#mongodb-pipeline-pipe.-planCacheStats) -  Повертає [кеш планів](https://www.mongodb.com/docs/manual/core/query-plans/) інформацію для колекції.
- [`$project`](oper_project.md) - Змінює форму кожного документа в потоці, наприклад, додаючи нові поля або видаляючи існуючі поля. Для кожного вхідного документа виводить один документ. Дивіться також [`$unset`](https://www.mongodb.com/docs/manual/reference/operator/aggregation/unset/#mongodb-pipeline-pipe.-unset) для видалення існуючих полів.
- [`$redact`](https://www.mongodb.com/docs/manual/reference/operator/aggregation/redact/#mongodb-pipeline-pipe.-redact) - Змінює форму кожного документа в потоці, обмежуючи вміст для кожного документа на основі інформації, що зберігається в самих документах. Включає в себе функції [`$project`](https://www.mongodb.com/docs/manual/reference/operator/aggregation/project/#mongodb-pipeline-pipe.-project) і [`$match`](https://www.mongodb.com/docs/manual/reference/operator/aggregation/match/#mongodb-pipeline-pipe.-match). Може використовуватися для реалізації редагування на рівні поля. Для кожного вхідного документа виводить один або нуль документів.
- [`$replaceRoot`](https://www.mongodb.com/docs/manual/reference/operator/aggregation/replaceRoot/#mongodb-pipeline-pipe.-replaceRoot) - Замінює документ на вказаний вбудований документ. Операція замінює всі існуючі поля у вхідному документі, включаючи поле `_id`. Укажіть документ, вбудований у вхідний документ, щоб підняти вбудований документ на вищий рівень.[`$replaceWith`](https://www.mongodb.com/docs/manual/reference/operator/aggregation/replaceWith/#mongodb- pipeline-pipe.-replaceWith) є псевдонімом для [`$replaceRoot`](https://www.mongodb.com/docs/manual/reference/operator/aggregation/replaceRoot/#mongodb-pipeline-pipe.-replaceRoot) етап.
- [`$replaceWith`](https://www.mongodb.com/docs/manual/reference/operator/aggregation/replaceWith/#mongodb-pipeline-pipe.-replaceWith) -  Замінює документ на вказаний вбудований документ. Операція замінює всі існуючі поля у вхідному документі, включаючи поле `_id`. Укажіть документ, вбудований у вхідний документ, щоб підняти вбудований документ на вищий рівень.[`$replaceWith`](https://www.mongodb.com/docs/manual/reference/operator/aggregation/replaceWith/#mongodb- pipeline-pipe.-replaceWith) є псевдонімом для [`$replaceRoot`](https://www.mongodb.com/docs/manual/reference/operator/aggregation/replaceRoot/#mongodb-pipeline-pipe.-replaceRoot) етап.
- [`$sample`](https://www.mongodb.com/docs/manual/reference/operator/aggregation/sample/#mongodb-pipeline-pipe.-sample) - Випадково вибирає вказану кількість документів зі свого входу.
- [`$search`](https://www.mongodb.com/docs/atlas/atlas-search/query-syntax/#mongodb-pipeline-pipe.-search) -  Виконує повнотекстовий пошук поля чи полів у колекції [Атлас](https://www.mongodb.com/docs/atlas/reference/atlas-search/query-syntax/). Примітка. `$search` доступний лише для кластерів MongoDB Atlas і недоступний для самокерованих розгортань. Щоб дізнатися більше, перегляньте [Етапи конвеєра агрегації пошуку Atlas.](https://www.mongodb.com/docs/atlas/reference/atlas-search/query-syntax/)
- [`$searchMeta`](https://www.mongodb.com/docs/atlas/atlas-search/query-syntax/#mongodb-pipeline-pipe.-searchMeta) -  Повертає різні типи документів із результатами метаданих для запиту [Atlas Search](https://www.mongodb.com/docs/atlas/atlas-search/) щодо [Atlas](https://www.mongodb.com/ docs/atlas/reference/atlas-search/query-syntax/). Примітка. `$searchMeta` доступний лише для кластерів MongoDB Atlas, на яких працює MongoDB версії 4.4.9 або новішої, і недоступний для самокерованих розгортань. Щоб дізнатися більше, перегляньте [Етапи конвеєра агрегації пошуку Atlas.](https://www.mongodb.com/docs/atlas/reference/atlas-search/query-syntax/)
- [`$set`](https://www.mongodb.com/docs/manual/reference/operator/aggregation/set/#mongodb-pipeline-pipe.-set) - Додає нові поля до документів. Подібно до [`$project`](https://www.mongodb.com/docs/manual/reference/operator/aggregation/project/#mongodb-pipeline-pipe.-project), [`$set`](https ://www.mongodb.com/docs/manual/reference/operator/aggregation/set/#mongodb-pipeline-pipe.-set) змінює форму кожного документа в потоці; зокрема, шляхом додавання нових полів до вихідних документів, які містять як існуючі поля з вхідних документів, так і нещодавно додані поля.[`$set`](https://www.mongodb.com/docs/manual/reference/operator/ aggregation/set/#mongodb-pipeline-pipe.-set) є псевдонімом для [`$addFields`](https://www.mongodb.com/docs/manual/reference/operator/aggregation/addFields/#mongodb- pipeline-pipe.-addFields) етап.
- [`$setWindowFields`](https://www.mongodb.com/docs/manual/reference/operator/aggregation/setWindowFields/#mongodb-pipeline-pipe.-setWindowFields) - Групує документи у вікна та застосовує один або кілька операторів до документів у кожному вікні.*Нове у версії 5.0*.
- [`$skip`](https://www.mongodb.com/docs/manual/reference/operator/aggregation/skip/#mongodb-pipeline-pipe.-skip) - Пропускає перші *n* документів, де *n* є вказаним номером пропуску, і передає решту документів незміненими в конвеєр. Для кожного вхідного документа виводить або нуль документів (для перших *n* документів), або один документ (якщо після перших *n* документів).
- [`$sort`](https://www.mongodb.com/docs/manual/reference/operator/aggregation/sort/#mongodb-pipeline-pipe.-sort) - Змінює порядок потоку документів за вказаним ключем сортування. Змінюється лише порядок; документи залишаються без змін. Для кожного вхідного документа виводить один документ.
- [`$sortByCount`](https://www.mongodb.com/docs/manual/reference/operator/aggregation/sortByCount/#mongodb-pipeline-pipe.-sortByCount) - Групує вхідні документи на основі значення вказаного виразу, а потім обчислює кількість документів у кожній окремій групі.
- [`$unionWith`](https://www.mongodb.com/docs/manual/reference/operator/aggregation/unionWith/#mongodb-pipeline-pipe.-unionWith) - Виконує об'єднання двох колекцій; тобто поєднує конвеєрні результати з двох колекцій в єдиний набір результатів.*Нове у версії 4.4*.
- [`$unset`](https://www.mongodb.com/docs/manual/reference/operator/aggregation/unset/#mongodb-pipeline-pipe.-unset) - Видаляє/виключає поля з документів.[`$unset`](https://www.mongodb.com/docs/manual/reference/operator/aggregation/unset/#mongodb-pipeline-pipe.-unset) — псевдонім для Етап [`$project`](https://www.mongodb.com/docs/manual/reference/operator/aggregation/project/#mongodb-pipeline-pipe.-project), який видаляє поля.
- [`$unwind`](https://www.mongodb.com/docs/manual/reference/operator/aggregation/unwind/#mongodb-pipeline-pipe.-unwind) - Деконструює поле масиву з вхідних документів, щоб вивести документ для *кожного* елемента. Кожен вихідний документ замінює масив значенням елемента. Для кожного вхідного документа виводить *n* документів, де *n* є кількістю елементів масиву та може дорівнювати нулю для порожнього масиву.

For aggregation expression operators to use in the pipeline stages, see [Aggregation Pipeline Operators.](https://www.mongodb.com/docs/manual/reference/operator/aggregation/)

### `db.aggregate()` Stages

MongoDB also provides the [`db.aggregate()`](https://www.mongodb.com/docs/manual/reference/method/db.aggregate/#mongodb-method-db.aggregate) method:

```
db.aggregate( [ { <stage> }, ... ] )
```

The following stages use the [`db.aggregate()`](https://www.mongodb.com/docs/manual/reference/method/db.aggregate/#mongodb-method-db.aggregate) method and not the [`db.collection.aggregate()`](https://www.mongodb.com/docs/manual/reference/method/db.collection.aggregate/#mongodb-method-db.collection.aggregate) method.

- [`$changeStream`](https://www.mongodb.com/docs/manual/reference/operator/aggregation/changeStream/#mongodb-pipeline-pipe.-changeStream) - Returns a [Change Stream](https://www.mongodb.com/docs/manual/changeStreams/#std-label-changeStreams) cursor for the collection.  This stage can only occur once in an aggregation pipeline and it must occur as the first stage.
- [`$currentOp`](https://www.mongodb.com/docs/manual/reference/operator/aggregation/currentOp/#mongodb-pipeline-pipe.-currentOp) - Returns information on active and/or dormant operations for the MongoDB deployment.
- [`$listLocalSessions`](https://www.mongodb.com/docs/manual/reference/operator/aggregation/listLocalSessions/#mongodb-pipeline-pipe.-listLocalSessions) - Lists all active sessions recently in use on the currently connected [`mongos`](https://www.mongodb.com/docs/manual/reference/program/mongos/#mongodb-binary-bin.mongos) or [`mongod`](https://www.mongodb.com/docs/manual/reference/program/mongod/#mongodb-binary-bin.mongod) instance. These sessions may have not yet propagated to the `system.sessions` collection.
- [`$documents`](https://www.mongodb.com/docs/manual/reference/operator/aggregation/documents/#mongodb-pipeline-pipe.-documents) - Returns literal documents from input values.

