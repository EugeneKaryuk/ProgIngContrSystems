# QEMU

https://www.qemu.org/docs/master/index.html

QEMU — це універсальний машинний емулятор і віртуалізатор із відкритим кодом. QEMU можна використовувати різними способами. Найпоширенішим є «**емуляція системи**», де вона надає віртуальну модель усієї машини (ЦП, пам’ять і емульовані пристрої) для запуску гостьової ОС. У цьому режимі ЦП може бути повністю емульований або він може працювати з гіпервізором, таким як KVM, Xen, Hax або Hypervisor.Framework, щоб дозволити гостьовій системі працювати безпосередньо на головному ЦП. Другим підтримуваним способом використання QEMU є «**емуляція режиму користувача**», де QEMU може запускати процеси, скомпільовані для одного ЦП, на іншому ЦП. У цьому режимі ЦП завжди емулюється. QEMU також надає ряд автономних утиліт командного рядка, таких як утиліта образу диска `qemu-img`, яка дозволяє створювати, конвертувати та змінювати образи дисків.

## Device Emulation

### Network emulation

https://www.qemu.org/docs/master/system/devices/net.html

QEMU може імітувати кілька мережних карт (наприклад, карти PCI або ISA на цільовому ПК) і може підключати їх до серверної мережі на хості або емульованому концентраторі. Різноманітні серверні модулі хост-мережі можна використовувати або для підключення NIC гостьової системи до реальної мережі (наприклад, за допомогою пристроїв TAP або мережевого стека непривілейованого режиму користувача), або до інших гостьових екземплярів, запущених в іншому процесі QEMU (наприклад, за допомогою серверної частини мережі хоста сокета).

#### Використання інтерфейсу TAP network

Це стандартний спосіб підключення QEMU до реальної мережі. QEMU додає віртуальний мережевий пристрій на вашому хості (називається `tapN`), і потім ви можете налаштувати його так, ніби це справжня карта Ethernet.

Існує віртуальний драйвер Ethernet для систем Windows 2000/XP, який називається `TAP-Win32`. Але він не входить до стандартного QEMU для Windows, тому вам потрібно буде отримати його окремо. Це частина пакету `OpenVPN`, тому завантажте OpenVPN з: https://openvpn.net/.

#### Використання мережний стек режиму користувача

Використовуючи опцію `-net user` (конфігурація за замовчуванням, якщо не вказано опцію `-net`), QEMU використовує мережевий стек у повністю призначеному для користувача режимі (вам не потрібні привілеї `root` для використання віртуальної мережі). Конфігурація віртуальної мережі така:

```
guest (10.0.2.15)  <------>  Firewall/DHCP server <-----> Internet
                      |          (10.0.2.2)
                      |
                      ---->  DNS server (10.0.2.3)
                      |
                      ---->  SMB server (10.0.2.4)
```

Віртуальна машина QEMU поводиться так, ніби вона знаходиться за брандмауером, який блокує всі вхідні з’єднання. Ви можете використовувати клієнт DHCP для автоматичного налаштування мережі у віртуальній машині QEMU. Сервер DHCP призначає адреси хостам, починаючи з `10.0.2.15`.

Щоб перевірити, чи працює мережа в режимі користувача, ви можете перевірити адресу `10.0.2.2` і переконатися, що ви отримали адресу в діапазоні `10.0.2.x` від віртуального сервера DHCP QEMU.

Зауважте, що трафік ICMP загалом не працює з мережею в режимі користувача. Однак `ping`, тобто ехо ICMP  на локальний маршрутизатор (`10.0.2.2`) має працювати. Якщо ви використовуєте QEMU в Linux >= 3.0, він може використовувати непривілейовані ICMP-сокети `ping`, щоб дозволити `ping` до Інтернету. Адміністратор хосту має встановити `ping_group_range`, щоб надати доступ до цих сокетів. Щоб дозволити ping для GID 100 (зазвичай це група користувачів):

```
echo 100 100 > /proc/sys/net/ipv4/ping_group_range
```

 sysctl -w net.ipv4.ping_group_range='0 214783647'

У разі використання вбудованого TFTP-сервера маршрутизатор також є TFTP-сервером. Якщо використовується параметр `'-netdev user,hostfwd=...'`, з'єднання TCP або UDP можна перенаправляти з хоста на гостьову систему. Це дозволяє, наприклад, перенаправляти підключення `X11`, `telnet` або `SSH`.

#### Hubs

QEMU може імітувати кілька концентраторів. Концентратор можна розглядати як віртуальне з’єднання між кількома мережевими пристроями. Такими пристроями можуть бути, наприклад, віртуальні карти Ethernet QEMU або віртуальні хост-пристрої Ethernet (пристрої TAP). Ви можете підключити гостьові мережеві карти або серверні частини хост-мережі до такого концентратора за допомогою параметрів `-netdev hubport` або `-nic hubport`. Застарілий параметр `-net` також підключає вказаний пристрій до емульованого концентратора з ID 0 (тобто концентратора за замовчуванням), якщо ви не вкажете тут `netdev` за допомогою `-net nic,netdev=xxx`.

#### Підключення емульованих мереж між екземплярами QEMU 

Використовуючи опцію `-netdev socket` (або `-nic socket` або `-net socket`), можна створювати емульовані мережі, які охоплюють кілька екземплярів QEMU. Перегляньте опис опції `-netdev socket` у [Invocation](https://www.qemu.org/docs/master/system/invocation.html#sec-005finvocation), щоб отримати базовий приклад.