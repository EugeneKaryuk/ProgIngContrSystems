**Програмна інженерія в системах управління. Лабораторний практикум.** Автор і лектор: Олександр Пупена 

| [<- до лаборних робіт](README.md) | [на основну сторінку курсу](../README.md) |
| --------------------------------- | ----------------------------------------- |
|                                   |                                           |

# Лабораторна робота №5. Основи роботи з Raspberry PI

**Тривалість**: 4 акад. години.

**Мета:** Навчитися створювати проекти та налаштовувати Raspberry PI для роботи в системах IoT. 

**Лабораторна установка**

- Апаратне забезпечення (див. таб. 5.1): ПК, Raspberry PI, датчики, монтажна плата, з'єднувачі
- Програмне забезпечення: Node-RED, balenaEtcher, PuTTY, Samba, VNC, Fritzing , Typora  

Таблиця 5.1. Перелік апаратних засобів, необхідних для лабораторної роботи. 

| Найменування                           | Кількість | Примітка                                        |
| -------------------------------------- | --------- | ----------------------------------------------- |
| Raspberry PI                           | 1         | У комплекті з блоком живлення та картою пам'яті |
| Макетна плата 170                      | 1         | або аналогічна                                  |
| Ультразвуковий датчик відстані HC-SR04 | 1         |                                                 |
| Датчик температури на 1-Wire DS18B20   | 1         |                                                 |
| Світлодіод                             | 1         |                                                 |
| Резистор 1 кОм                         | 1         |                                                 |
| Резистор 10 кОм                        | 1         |                                                 |
| Провід dupont (розетка-вилка)          | 6         | бажано 2 чорні, червоний, зелений і білий       |


## Порядок виконання роботи 

Рекомендується попередньо ознайомитися з матеріалами лекції по RPI за [посиланням](../Лекц/RaspberryPi.md).

Доступні записи відео:

- [Частина 1](https://youtu.be/cdxhgrJldw8)
- [Частина 2](https://youtu.be/ZDklBHp21LQ)

### 1. Підготовка образу карти налаштування Raspberry Pi

У даній частині лабораторної роботи проводиться підготовка Raspberry Pi для проведення інших лабораторних робіт та курсового проектування. Встановлення необхідного програмного забезпечення проводиться таким чином щоб не підключати клавіатуру, мишу та монітор до Raspberry PI. 

#### 1.1. Встановлення ОС та налаштування Raspberry PI

Виконайте встановлення та налаштування образу карти відповідно до [цього посилання](https://github.com/asu-in-ua/atpv/blob/main/micropc/rpiinstall/lab.md). Є також інший спосіб описаний за [цим посиланням](oldinstallrpi.md)

#### 1.2. Встановлення Node-RED 

Встановіть Node-RED використовуючи скрипт, як описано за [цим посиланням](https://github.com/pupenasan/NodeREDGuidUKR/blob/master/base/install.md#встановлення-та-оновлення-node-red )


### 2.1.  Використання Fritzing


#### 2.1. Завантаження Fritzing

- [ ] Завантажте на ПК безкоштовну бета-версію середовища проектування Fritzing за одним із посилань нижче або платну версію [з офіційного сайту](https://fritzing.org/download/)

- [Windows 64bit](https://web.archive.org/web/20210415140938/https://fritzing.fra1.cdn.digitaloceanspaces.com/adc8999ea0de8eb4afa12cecec80473d.zip?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=LHATV5BDBXOYWUQGNV66%2F20210415%2Ffra1%2Fs3%2Faws4_request&X-Amz-Date=20210415T140938Z&X-Amz-Expires=1200&X-Amz-SignedHeaders=host&X-Amz-Signature=300d43da9d6baf1c608504eb0f91a5a44969487e8127b990c9583ee4f71786c1)
- [Windows 32bit](https://web.archive.org/web/20210415140938/https://fritzing.fra1.cdn.digitaloceanspaces.com/adc8999ea0de8eb4afa12cecec80473d.zip?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=LHATV5BDBXOYWUQGNV66%2F20210415%2Ffra1%2Fs3%2Faws4_request&X-Amz-Date=20210415T140938Z&X-Amz-Expires=1200&X-Amz-SignedHeaders=host&X-Amz-Signature=300d43da9d6baf1c608504eb0f91a5a44969487e8127b990c9583ee4f71786c1)
- [Linux 64bit](https://web.archive.org/web/20170107142927/http://fritzing.org/media/downloads/fritzing-0.9.3b.linux.AMD64.tar.bz2)
- [Linux 32bit](https://web.archive.org/web/20170106114244/http://fritzing.org/media/downloads/fritzing-0.9.3b.linux.i386.tar.bz2)
- [Mac OS X 10.7](https://web.archive.org/web/20171026063218/http://fritzing.org/media/downloads/Fritzing0.9.3b.dmg)

#### 2.2. Завантаження бібліотеки зображень RPI3

- [ ] Завантажте на ПК бібліотеку RPI3 з іменем `Raspberry Pi 3_3.fzpz` для  Fritzing  за [посиланням](https://fritzing.org/projects/raspberry-pi-3). Обговорення бібліотеки на форумі доступне за [посиланням ](https://fritzing.org/projects/raspberry-pi-3)  

#### 2.3. Запуск, налаштування Fritzing та встановлення бібліотеки RPI3

- [ ] Розпакуйте архів та запустіть `Fritzing.exe`. Імпортуйте файл з іменем `Raspberry Pi 3_3.fzpz` з панелі `Parts`, як це показано на рис.5.10.

![](RPIMedia/18.png)

рис.5.10. Встановлення бібліотеки RPI3

- [ ] Через меню `Edit->Prefernces` Ви можете вибрати найзручнішу для Вас мову інтерфейсу 

#### 2.4. Розміщення елементів на платі для схеми керування діодом

- [ ] Активуйте режим відображення макетної плати через меню `View->Show BreadBoard`, або натиснувши відповідну вкладку. На панелі Parts перейдіть в розділ Mine, перенесіть туди RPI3

![](RPIMedia/19.png)

рис.5.11. Розміщення плати та RPI

- [ ] У розділі `CORE` панелі інструментів `Parts` виберіть два елементи:

- `Basic -> Resistor` 

- `Output -> RED LED`

  ![](RPIMedia/20.png)
  
  рис.5.12. Розміщення елементів на платі для схеми керування діодом

- [ ] У налаштуваннях резистора вкажіть опір 1 Ком (Resistance = 1kΩ).

#### 2.5. Реалізація схеми підключення 

- [ ] Перейдіть на вкладку Shematic  `View->Show Schematic`, або натиснувши відповідну вкладку.
- [ ] Розмістіть на схемі елементи, щоб схема була більш читабельною, використовуючи команди з контекстного меню  `Flip vertical`, `Rotate` і т.п. 
- [ ] З'єднайте елементи на схемі, як показано на рисунку.

 ![](RPIMedia/21.png) 

рис.5.13. З'єднання елементів на схемі

- [ ] У налаштуванні провідників виберіть колір, для підключення `GPIO4` до `LED1` - червоний, для підключення `R1` до `GND` - чорний.

#### 2.6. Коригування схеми підключення на платі

- [ ] Перейдіть на режим відображення макетної плати. З'єднайте контакти, які обозначені пунктиром. Змініть кольори провідників. 

![](RPIMedia/22.png)

рис.5.14. Скоригована схема підключення

- [ ] Використовуючи `Edit -> Add Note` добавте коментар до схеми `Схема Прізвище Ім''я`, де вкажіть своє прізвище.  

#### 2.7. Збереження проекту та експорт схем

- [ ] Збережіть файл проекту з іменем `Diod_Name`, де замість Name вкажіть своє прізвище латинськими літерами.  

- [ ] У папці проекту Git, яка була створена для лабораторної роботи 3, що має зв'язок з GitHub (наприклад `C:\Users\username\.node-red\projects\project1`) , створіть папку `Lab5` а в ній папку `Schemas`. 

- [ ] Експортуйте у папку `Lab5` кілька файлів з проекту:

- перемкніть на панель макетної плати `Breadboard` та експортуйте список деталей `File -> Export -> List of Parts`
- та експортуйте схему у вигляді PNG `File -> Export -> as Image -> PNG... `
- перемкніть на панель схеми `Schematic` та експортуйте схему у вигляді PNG `File -> Export -> as Image -> PNG... `

### 3. Реалізація та перевірка: підключення та керування діодом

#### 3.1. Збірка та перевірка схеми

- [ ] Вимкніть Raspberry PI, якщо він включений.

- [ ] Подивіться уважно на реальне розміщення контактів GPIO:

![](RPIMedia/26.jpg) 

рис.5.15. Розміщення контактів GPIO на RPI 3

![](RPIMedia/27.png)

рис.5.16. Розміщення контактів GPIO на RPI 3 (альтернативний вигляд)

- [ ] Попросіть у викладача необхідні елементи, та підключіть їх, відповідно до розробленої схеми. Уважно перевірте підключення.

 ![](RPIMedia/23.jpg)

рис.5.17. Підключення світлодіода до RPI 3 (альтернативний вигляд)

#### 3.2. Перевірка схеми викладачем

- [ ] Покличте викладача, щоб він перевірив схему. Якщо схема одобрена, перейдіть до наступного пункту. 

#### 3.3. Увімкнення та первинні налаштування RPI

- [ ] Увімкніть RPI.  За допомогою VNC зайдіть на робочий стіл RPI. 

- [ ] Зайдіть в меню `Налаштування -> Raspberry Pi Configuration` і на вкладці `Interfaces` активуйте Remote GPIO.

![](RPIMedia/23.png)   

рис.5.18. Активація GPIO у RPI

#### 3.4. Ручний запуск Node-RED

- [ ] Для запуску Node-RED на RPI3 використовується команда у вікні терміналу 

```bash
node-red-start
```

- [ ] Якщо закрити вікно терміналу (або натиснути Ctrl + C), то Node-RED все одно продовжить працювати, але в фоновому режимі. Щоб зупинити Node-RED, запустіть команду 

```bash
node-red-stop
```

- [ ] Також Node-RED припинить свою роботу після перезавантаження RPI3.

![](RPIMedia/31.png)

рис.5.19. Ручний запуск Node-RED з консолі

- [ ] Щоб відкрити вікно редактора в браузері необхідно прописати IP-адресу та номер порту 127.0.0.1:1880.

![](RPIMedia/32.png)

рис.5.20. Відкриття Node-RED в браузері

#### 3.5. Автоматичний запуск Node-RED

Сценарій установки для Pi також налаштовує його на запуск як служби. Це означає, що він може працювати у фоновому режимі та бути включеним для  автоматичного запуску під час завантаження.

Для роботи зі службою надаються наступні команди:

- `node-red-start` -- це запускає службу Node-RED та відображає її вихідний журнал. Натискання `Ctrl-C` або закривання вікна *НЕ* зупиняє службу; вона буде залишатися запущеною на задньому фоні
- `node-red-stop` - зупиняє службу Node-RED
- `node-red-restart` - зупиняє і перезапускає службу Node-RED
- `node-red-log` - тут відображається вихід журналу служби

Ви також можете запустити службу Node-RED на робочому столі Raspbian, вибравши опцію `Menu -> Programming -> Node-RED`.

- [ ] Встановіть автозапуск за допомогою наступних команд:

```
sudo systemctl enable nodered.service
```

- [ ] Перезавантажте RPI3 і переконайтесь що Node-RED запускається автоматично при старті системи. Якщо ні повторіть попередні пункти.

#### 3.6. Створення програми та перевірка програми для Node-RED

- [ ] Зайдіть на сторінку програмування Node-RED на RPI3. Створіть програму для керування діодом.

![](RPIMedia/24.png) 

рис.5.21. Фрагмент застосунку для роботи з входами/виходами GPIO

- [ ] Перевірте роботу програми  натискаючи `Inject TRUE` а потім `Inject FALSE`

#### 3.7. Вивід кнопок включення/виключення на Веб-інтерфейс

- [ ] Встановіть бібліотеку `node-red-dashboard` , якщо вона ще не була встановлена.

- [ ] Самостійно реалізуйте керування кнопками вкл/откл з графічного Веб-інтерфейсу.

### 4. Розробка документації

#### 4.1. Збереження вигляду та коду програми користувача

- [ ] Зробіть копію екрану програми. Використовуючи графічний редактор виріжіть робочу частину програми і збережіть в форматі PNG на ПК в папці  проекту `Lab5`. 

- [ ] Зробіть експорт потоку як форматований JSON та завантажте через кнопку Download. Збережіть в папці проекту  `Lab5` з назвою `diod.json`.

![](RPIMedia/25.png)

рис.5.22. Експорт потоку

#### 4.2. Завантаження та встановлення Typora (або аналогічного)

- [ ] Завантажте та встановіть MarkDown редактор Typora або аналогічний:

-  завантажте редактор (Typora [для Windows](https://typora.io/#windows)) 

- встановіть редактор

#### 4.3. Створення файлу README.MD 

- [ ] У папці проекту `Lab5` на ПК створіть файл з назвою README.MD. 

Зміст файлів, які так називаються автоматично відображаються в GitHub. Цей файл буде звітом з лабораторної роботи.

#### 4.4. Оформлення лабораторної роботи

- [ ] Повторіть матеріал [лекції](../Лекц/MarkDown.md) по MarkDown.

- [ ] Відкрийте [приклад](RPIMedia\Example\README.MD) оформлення лабораторної роботи та зробіть аналогічне оформлення для зробленої частини.

#### 4.5. Завантаження матеріалів на GitHub

- [ ] Зробіть коміт та завантажте (push) проект на GitHub. 

- [ ] Зайдіть на GitHub в репозиторій проекту. Зайдіть в папку Lab4, там повинен відображатися Ваш звіт. Перевірте, що він дійсно відображається коректно. 

- [ ] За необхідності зробіть виправлення та повторіть коміт та завантаження до GitHub.   


### 5. Використання датчика відстані

У цьому пункті наводяться кроки для підключення ультразвукового датчика відстані HC-SR04, та його використання в Node-RED.

#### 5.1. Підключення датчика відстані до RPI

- [ ] Вимкніть живлення Raspberry PI. 

- [ ] Зберіть нову схему, як показано на рисунку. Уважно перевірте правильність.

![](RPIMedia/28.png)

рис.5.23. Принципова схема установки

- [ ] **Зверніть особливу увагу на найменування контактів підключення ультразвукового датчика відстані. На монтажній схемі він зображений повернуто до плати, по факту його зручніше розміщувати повернуто від плати.**

Таблиця 5.2. Контакти датчика відстані підключені до контактів RPI

| RPI             | Датчики HC-SR04 |
| --------------- | --------------- |
| +5V (pin 2)     | Vcc             |
| GPIO27 (pin 13) | Trig            |
| GPIO17 (pin 11) | Echo            |
| Gnd (pin 9)     | Gnd             |

![](RPIMedia/29.png)

рис.5.24. Схема підключення установки

- [ ] Попросіть викладача перевірити схему і у випадку підтвердження правильності, переходьте до виконання наступного пункту. 

#### 5.2. Встановлення бібліотеки node-red-node-pisrf

- [ ] У node-RED для RPI встановіть бібліотеку node-red для роботи з ультразвуковим датчиком: **node-red-node-pisrf**
- [ ] Якщо при роботі виникає помилка, необхідно вручну змінити файл `python-rpi.gpio` у папці `/usr/share/doc`, як описано [за цим посиланням](https://github.com/node-red/node-red-nodes/issues/865) , видаливши наступний фрагмент коду:

```js
        else if (!fs.existsSync("/usr/share/doc/python-rpi.gpio")) { RED.log.warn("rpi-srf : "+RED._("node-red:rpi-gpio.errors.libnotfound")); allOK = false; }
```

#### 5.3. Створення та перевірка програми користувача

- [ ] Видаліть старий фрагмент програми керування світлодіодом.

- [ ] Використовуючи вузол `rpi srf` з розділу інструментів `Raspberry PI` реалізуйте програму, показану на рисунку:

![](RPIMedia/30.png)

рис.5.25. Фрагмент програми для реалізації роботи з датчиком відстані

- [ ] Зробіть розгортання проекту та первірте роботу. 

- [ ] Активувавши вузол **Debug** можна побачити данні які йдуть від датчика відстані. 

#### 5.4. Виведення на Веб-інтерфейс

- [ ] Виведіть значення на Веб-інтерфейс, використовуючи `dashboard` . 
- [ ] Проаналізуйте в яких одиницях показує значення відстані. 

#### 5.5. Керування яскравістю світлодіода в залежності від відстані до об'єкта 

- [ ] Створіть програму, яка показана на рисунку.



![img](RPIMedia/3.png)

рис.5.26. Фрагмент програми керування яскравістю світлодіода в залежності від відстані до об'єкта 

Ця програма керує яскравістю свічення світлодіоду в залежності від відстані до об'єкту. Від 1 метру тьмяне світіння, чим ближче, тим яскравіше.

- [ ] Зробіть розгортання, підводячи якийсь предмет до датчика наближення перевірте роботу програми.   

#### 5.6. Фіксація у папці проекту 

- [ ] Зробіть копію екрану програми. Використовуючи графічний редактор виріжіть робочу частину програми і збережіть в форматі PNG на ПК в папці  проекту`Lab4` під назвою `Usonic.png`. 

- [ ] Зробіть експорт потоку як форматований JSON та завантажте через кнопку Download. Збережіть в папці проекту  `Lab4` з назвою `Usonic.json`. 

- [ ] Зробіть оформлення у файлі README.md, який Ви редагували до цього.

- [ ] Зробіть коміт та завантажте (push) проект на GitHub. 

- [ ] Зайдіть на GitHub в репозиторій проекту. Зайдіть в папку Lab4, там повинен відображатися Ваш змінений звіт. Перевірте, що він дійсно відображається коректно. 

- [ ] За необхідності зробіть виправлення та повторіть коміт та завантаження до GitHub.    

### 6. Підключення датчика температури по 1-Wire

#### 6.1. Підготовка RPI.

- [ ] Видаліть стару програму на RPI.

- [ ] Вимкніть живлення Raspberry PI.  

- [ ] Відключіть усі проводи з попередньої частини роботи.

#### 6.2. Активування 1-Wire на RPI

- [ ] Увімкніть живлення на RPI. 

- [ ] Зайдіть через VNC на робочий стіл RPI та через налаштування активуйте 1-Wire інтерфейс.

![img](RPIMedia/4.png)

рис.5.27. Активація інтерфейсу 1-Wire на RPI

- [ ] Вимкніть живлення Raspberry PI.

#### 6.3. Підключення датчика температури до RPI через 1-Wire

- [ ] Підключіть датчик температури відповідно до вказаної схеми.

- [ ] Зверніть увагу, що використовується живлення 3,3 В а резистор номіналом 10 кОм.

![img](RPIMedia/8.png)

рис.5.28. Схема підключення датчика температури до RPI через 1-Wire

#### 6.4. Встановлення бібліотеки node-red-contrib-sensor-ds18b20

- [ ] Увімкніть RPI. 

- [ ] Інсталюйте в node-red потрібну бібліотеку: `node-red-contrib-sensor-ds18b20` Ця бібліотека спрощує роботу з датчиками температури `ds18b20`

- [ ] перезавантажте систему

#### 6.5. Створення та перевірка програми користувача

- [ ] Створіть програму, наведену на рисунку.  Ідентифікатор датчика температури вибирається зі списку (повинен знайтися автоматично) .

![img](RPIMedia/7.png)

рис.5.29. Фрагмент програми вимірювання температури через 1-Wire

- [ ] Зробіть розгортання та перевірте її роботу.


#### 6.6. Дооформлення роботи

- [ ] Оформіть дану частину аналогічно як в п.6.2. 

## Питання до захисту

1. Перерахуйте кроки які використовувалися в лабораторній роботі для розгортання на RPI потрібної ОС та застосунків.
2. Розкажіть навіщо і яким чином активувався SSH на пристрої RPI .
3. Яке призначення і як в лабораторній роботі використовувалася утиліти Putty?
4. Яке призначення і як в лабораторній роботі використовувався сервіс VNC?
5. Яке призначення і як в лабораторній роботі використовувався пакунок Fritzing?
6. Розкажіть про призначення GPIO.
7. Як забезпечується автоматичний запуск Node-RED як служби?
8. Яке призначення датчиків, які використовувалися в лабораторній роботі?
9. Розкажіть про основні властивості мережі 1-Wire.
